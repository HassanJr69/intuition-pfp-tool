<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Editor with Glasses</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        #canvas-container {
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        #controls {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="controls">
        <input type="file" id="backgroundInput" accept="image/*" />
        <input type="file" id="glassesInput" accept="image/*" />
        <button onclick="downloadImage()">Download Image</button>
    </div>
    <div id="canvas-container">
        <canvas id="canvas" width="500" height="500"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script>
        // Initialize Fabric.js canvas
        const canvas = new fabric.Canvas('canvas', {
            backgroundColor: '#fff',
            selection: true
        });

        let backgroundImg, glassesImg;

        // Handle background image upload
        document.getElementById('backgroundInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    fabric.Image.fromURL(event.target.result, function (img) {
                        // Remove existing background if any
                        if (backgroundImg) {
                            canvas.remove(backgroundImg);
                        }
                        // Scale image to fit canvas
                        img.scaleToWidth(canvas.getWidth());
                        img.scaleToHeight(canvas.getHeight());
                        img.set({
                            left: 0,
                            top: 0,
                            selectable: true, // Allow selection for resizing
                            hasControls: false, // No visible controls
                            hasBorders: false // No visible borders
                        });
                        backgroundImg = img;
                        canvas.add(img);
                        canvas.sendToBack(img); // Ensure background stays behind glasses
                        canvas.renderAll();
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle glasses image upload
        document.getElementById('glassesInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    fabric.Image.fromURL(event.target.result, function (img) {
                        // Remove existing glasses if any
                        if (glassesImg) {
                            canvas.remove(glassesImg);
                        }
                        // Scale glasses to a reasonable size
                        img.scaleToWidth(canvas.getWidth() / 4);
                        img.set({
                            left: canvas.getWidth() / 2,
                            top: canvas.getHeight() / 2,
                            selectable: true, // Allow selection
                            hasControls: true, // Show resize/rotate handles
                            hasBorders: true, // Show borders
                            centeredScaling: true,
                            centeredRotation: true
                        });
                        glassesImg = img;
                        canvas.add(img);
                        canvas.bringToFront(img); // Ensure glasses are on top
                        canvas.renderAll();
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // Download image with cropped background
        function downloadImage() {
            if (!backgroundImg && !glassesImg) {
                alert('Please upload both a background image and glasses.');
                return;
            }

            // Calculate bounding box of all objects
            const objects = canvas.getObjects();
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

            objects.forEach(obj => {
                const bound = obj.getBoundingRect();
                minX = Math.min(minX, bound.left);
                minY = Math.min(minY, bound.top);
                maxX = Math.max(maxX, bound.left + bound.width);
                maxY = Math.max(maxY, bound.top + bound.height);
            });

            // Add small padding
            const padding = 10;
            minX -= padding;
            minY -= padding;
            maxX += padding;
            maxY += padding;

            // Create a temporary canvas for the cropped image
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = maxX - minX;
            tempCanvas.height = maxY - minY;
            const tempCtx = tempCanvas.getContext('2d');

            // Render the cropped area
            canvas.getObjects().forEach(obj => {
                const bound = obj.getBoundingRect();
                const imgData = canvas.getContext().getImageData(
                    bound.left, bound.top, bound.width, bound.height
                );
                tempCtx.putImageData(imgData, bound.left - minX, bound.top - minY);
            });

            // Download the image
            const dataURL = tempCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = 'edited_image.png';
            link.click();
        }
    </script>
</body>
</html>
